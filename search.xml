<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>SpringBoot实现分片上传文件</title>
    <url>/2023/10/21/SpringBoot%E5%AE%9E%E7%8E%B0%E5%88%86%E7%89%87%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6/</url>
    <content><![CDATA[<p>大家好，这里是胡编乱码，欢迎大家收看本期内容，本期内容将介绍文件分片上传的技术和具体实现。</p>
<p>本次演示的 Demo 前端比较简单，所以使用纯 html&#x2F;js&#x2F;css 来实现，前端的网络请求我将使用 Axios.js 来完成。服务端的话我将使用 SpringBoot 来开发，那么废话不多说，我们直接开始。</p>
<h3 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h3><p>实现分片上传的原理大概分为两步，分别对应前后端：</p>
<ol>
<li><p>前端将文件进行分片、计算 MD5 码和将分片上传。</p>
</li>
<li><p>服务端将接收到的分片文件根据 MD5 码拼接成一个完整的文件。</p>
</li>
</ol>
<p><img  
                     lazyload
                     alt="image"
                     data-src="/images/20231021/SpringBoot%E5%AE%9E%E7%8E%B0%E5%88%86%E7%89%87%E4%B8%8A%E4%BC%A0.jpg"
                      alt="实现原理"
                ></p>
<h3 id="服务端实现"><a href="#服务端实现" class="headerlink" title="服务端实现"></a>服务端实现</h3><p>首先我们创建一个 SpringBoot 项目，创建方式可以通过官网提供的创建项目页面进行创建，网站地址为：<a class="link"   href="https://start.spring.io/" >https://start.spring.io/<i class="fas fa-external-link-alt"></i></a>。下图是我选择的创建配置，依赖的添加上Web依赖即可：</p>
<p><img  
                     lazyload
                     alt="image"
                     data-src="/images/20231021/2023-10-20-21-34-58-image.png"
                     
                ></p>
<p>然后我们点击 Generate 按钮将我们的项目工程下载下来，解压后通过打开项目进行开发就可以。接下来我们编写分片上传接口。首先我们确定一下上传的参数有哪些？</p>
<ol>
<li><p>文件内容</p>
</li>
<li><p>文件名称</p>
</li>
<li><p>文件MD5码</p>
</li>
<li><p>文件分片总数</p>
</li>
<li><p>当前分片索引</p>
</li>
</ol>
<p>根据上面5个参数我们就可以完成分片上传服务端的实现，其中文件名称是用来在拼接为完整的文件后对文件进行命名，MD5是用来识别哪些需要拼接在一起，文件分片总数是用来判断文件是否已经上传完成，当前分片索引是用来确定当前接受到的文件分片应该拼接到最终文件的哪里，下面是实现代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> vip.huhailong.uploadslice.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.RandomAccessFile;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 胡编乱码</span></span><br><span class="line"><span class="comment"> * 文件接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/file&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileController</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span>  <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(FileController.class);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Value(&quot;$&#123;slice.saveDir&#125;&quot;)</span></span><br><span class="line">  <span class="keyword">private</span> String saveDir;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, Integer&gt; fileCountMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 分片上传接口</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> file 分片文件</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> fileName 文件名称</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> fileMd5 文件MD5值</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> chunkCount 分片总数量</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> currentIndex 当前分片索引</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@PostMapping(&quot;/uploadBySlice&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">float</span> <span class="title function_">upload</span><span class="params">(MultipartFile file, String fileName, String fileMd5, Integer chunkCount, Integer currentIndex)</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">tempFilePath</span> <span class="operator">=</span> saveDir + File.separator + fileMd5 + <span class="string">&quot;.tmp&quot;</span>;</span><br><span class="line">    checkFilePath();</span><br><span class="line">    <span class="keyword">try</span>(<span class="type">RandomAccessFile</span> <span class="variable">accessFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(tempFilePath,<span class="string">&quot;rw&quot;</span>))&#123;</span><br><span class="line">      accessFile.seek(currentIndex);</span><br><span class="line">      accessFile.write(file.getBytes());</span><br><span class="line">      fileCountMap.put(fileMd5, fileCountMap.getOrDefault(fileMd5,<span class="number">0</span>)+<span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span>(Objects.equals(fileCountMap.get(fileMd5), chunkCount))&#123;</span><br><span class="line">	  	accessFile.close();</span><br><span class="line">        <span class="type">File</span> <span class="variable">tempFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(tempFilePath);</span><br><span class="line">        <span class="type">File</span> <span class="variable">finallyFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(saveDir + File.separator + fileName);</span><br><span class="line">        tempFile.renameTo(finallyFile);</span><br><span class="line">        tempFile.delete();</span><br><span class="line">        logger.info(<span class="string">&quot;上传完成：&#123;&#125;&quot;</span>,saveDir+File.separator+fileName);</span><br><span class="line">        fileCountMap.remove(fileMd5);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1.0f</span>;</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        logger.info(<span class="string">&quot;&#123;&#125;-&#123;&#125;件上传中&quot;</span>,fileMd5,currentIndex);</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">float</span>) fileCountMap.get(fileMd5) / chunkCount;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">      logger.error(e.getMessage());</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkFilePath</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(saveDir);</span><br><span class="line">    <span class="keyword">if</span>(!file.exists())&#123;</span><br><span class="line">      file.mkdirs();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>前端代码实现</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>文件分片上传<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;axios.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;spark-md5.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">html</span>,<span class="selector-tag">body</span>&#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">display</span>: flex;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">align-items</span>: center;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">justify-content</span>: center;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">height</span>: <span class="number">100vh</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: <span class="number">#333</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.uploadBox</span>&#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>: <span class="number">600px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">box-shadow</span>: <span class="number">2px</span> <span class="number">3px</span> <span class="number">10px</span> black;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">4px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">display</span>: flex;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">flex-direction</span>: column;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">align-items</span>: end;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">justify-content</span>: center;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: gainsboro;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.uploadBtn</span>&#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>: <span class="number">100px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">height</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: darkcyan;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">4px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">text-align</span>: center;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: white;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">display</span>: flex;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">5px</span> <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">align-items</span>: center;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">justify-content</span>: center;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-weight</span>: bold;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">cursor</span>: pointer;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.uploadBtn</span><span class="selector-pseudo">:hover</span>&#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">opacity</span>: <span class="number">0.9</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.fileInfo</span>&#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">text-align</span>: left;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">display</span>: flex;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">justify-content</span>: center;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.fileInfo</span> &gt; <span class="selector-tag">table</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border</span>: <span class="number">1px</span> solid black;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-collapse</span>: <span class="number">0px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin-top</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">4px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">header</span>&#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">position</span>: fixed;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">top</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">height</span>: <span class="number">40px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: <span class="number">#000</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: white;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">display</span>: flex;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">align-items</span>: center;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">justify-content</span>: start;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">header</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&quot;padding-left: 10px; font-size: 18px; font-weight: bold;&quot;</span>&gt;</span>胡编乱码<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;uploadBox&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;upload&quot;</span> <span class="attr">class</span>=<span class="string">&quot;uploadBtn&quot;</span>&gt;</span>上传文件<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;file&quot;</span> <span class="attr">hidden</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;fileInfo&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">caption</span>&gt;</span>文件信息<span class="tag">&lt;/<span class="name">caption</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span>&gt;</span>文件名称<span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">td</span> <span class="attr">id</span>=<span class="string">&quot;fileName&quot;</span>&gt;</span>为选择文件<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span>&gt;</span>文件大小<span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">td</span> <span class="attr">id</span>=<span class="string">&quot;fileSize&quot;</span>&gt;</span>0 kb<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span>&gt;</span>分片大小<span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">td</span> <span class="attr">id</span>=<span class="string">&quot;sliceSize&quot;</span>&gt;</span>0 kb<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span>&gt;</span>分片数量<span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">td</span> <span class="attr">id</span>=<span class="string">&quot;sliceCount&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span>&gt;</span>MD5码<span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">td</span> <span class="attr">id</span>=<span class="string">&quot;fileMd5&quot;</span>&gt;</span>-<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">footer</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span>&gt;</span>上传状态<span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">td</span> <span class="attr">id</span>=<span class="string">&quot;status&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">footer</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;width: 100%; text-align: left; padding-top: 10px; font-size: 14px; color: gray;&quot;</span>&gt;</span>V0.0.1 2023/10/21 15:10<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;upload&quot;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>,<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;file&quot;</span>).<span class="title function_">click</span>()</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;file&quot;</span>).<span class="title function_">addEventListener</span>(<span class="string">&quot;change&quot;</span>,<span class="function">(<span class="params">e</span>)=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">let</span> file = e.<span class="property">target</span>.<span class="property">files</span>[<span class="number">0</span>];</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;fileName&quot;</span>).<span class="property">innerText</span> = file.<span class="property">name</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;fileSize&quot;</span>).<span class="property">innerText</span> = <span class="title class_">Math</span>.<span class="title function_">ceil</span>(file.<span class="property">size</span> / <span class="number">1024</span>) + <span class="string">&#x27;kb&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">sliceFileAndUpload</span>(file, <span class="number">1000</span> * <span class="number">1024</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">sliceFileAndUpload</span>(<span class="params">file, chunkSize</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> filePartList = [];</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> blobSlice = <span class="title class_">File</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">slice</span> || <span class="title class_">File</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">mozSlice</span> || <span class="title class_">File</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">webkitSlice</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> chunkCount = <span class="title class_">Math</span>.<span class="title function_">ceil</span>(file.<span class="property">size</span> / chunkSize);  <span class="comment">//分片数量</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;sliceSize&quot;</span>).<span class="property">innerHTML</span> = chunkSize;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;sliceCount&quot;</span>).<span class="property">innerHTML</span> = chunkCount;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> currentChunk = <span class="number">0</span>;   <span class="comment">//当前索引</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> spark = <span class="keyword">new</span> <span class="title class_">SparkMD5</span>.<span class="title class_">ArrayBuffer</span>();</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> fileReader = <span class="keyword">new</span> <span class="title class_">FileReader</span>();</span></span><br><span class="line"><span class="language-javascript">            fileReader.<span class="property">onload</span> = <span class="function"><span class="params">e</span> =&gt;</span> &#123;  <span class="comment">//FileReader.onload 回调函数会在每次读区完成后触发</span></span></span><br><span class="line"><span class="language-javascript">                spark.<span class="title function_">append</span>(e.<span class="property">target</span>.<span class="property">result</span>);</span></span><br><span class="line"><span class="language-javascript">                currentChunk++;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span>(currentChunk &lt; chunkCount)&#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">loadNext</span>()</span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;fileMd5&quot;</span>).<span class="property">innerHTML</span> = <span class="string">&#x27;计算中……&#x27;</span></span></span><br><span class="line"><span class="language-javascript">                &#125;<span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> fileMd5 = spark.<span class="title function_">end</span>();</span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;fileMd5&quot;</span>).<span class="property">innerHTML</span> = fileMd5;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> progressEl = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;status&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                    filePartList.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item,index</span>)=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">let</span> formData = <span class="keyword">new</span> <span class="title class_">FormData</span>();</span></span><br><span class="line"><span class="language-javascript">                        formData.<span class="title function_">append</span>(<span class="string">&#x27;file&#x27;</span>, item.<span class="property">filePart</span>);</span></span><br><span class="line"><span class="language-javascript">                        formData.<span class="title function_">append</span>(<span class="string">&#x27;fileMd5&#x27;</span>, fileMd5);</span></span><br><span class="line"><span class="language-javascript">                        formData.<span class="title function_">append</span>(<span class="string">&#x27;chunkCount&#x27;</span>, chunkCount);</span></span><br><span class="line"><span class="language-javascript">                        formData.<span class="title function_">append</span>(<span class="string">&#x27;currentIndex&#x27;</span>, item.<span class="property">currentIndex</span>);</span></span><br><span class="line"><span class="language-javascript">                        formData.<span class="title function_">append</span>(<span class="string">&#x27;fileName&#x27;</span>, file.<span class="property">name</span>);</span></span><br><span class="line"><span class="language-javascript">                        axios.<span class="title function_">post</span>(<span class="string">&#x27;/file/uploadBySlice&#x27;</span>,formData,&#123;<span class="attr">headers</span>:&#123;<span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;multipart/form-data&#x27;</span>&#125;&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(res.<span class="property">data</span>)</span></span><br><span class="line"><span class="language-javascript">                            <span class="keyword">if</span>(res.<span class="property">data</span> == <span class="number">1</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                              progressEl.<span class="property">innerHTML</span> = <span class="string">&#x27;上传完成&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">                            &#125;<span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="language-javascript">                              progressEl.<span class="property">innerHTML</span> = <span class="string">&#x27;上传中……&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">                            &#125;</span></span><br><span class="line"><span class="language-javascript">                        &#125;)</span></span><br><span class="line"><span class="language-javascript">                    &#125;)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            fileReader.<span class="property">onerror</span> = <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;文件读取处理发生错误&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">function</span> <span class="title function_">loadNext</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> temp = &#123;&#125;;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> start = currentChunk * chunkSize;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> end = (start + chunkSize) &gt;= file.<span class="property">size</span> ? file.<span class="property">size</span> : start + chunkSize;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> filePart = blobSlice.<span class="title function_">call</span>(file, start, end);    <span class="comment">//分隔文件</span></span></span><br><span class="line"><span class="language-javascript">                temp.<span class="property">currentIndex</span> = start;</span></span><br><span class="line"><span class="language-javascript">                temp.<span class="property">filePart</span> = filePart;</span></span><br><span class="line"><span class="language-javascript">                filePartList.<span class="title function_">push</span>(temp);    <span class="comment">//将分片文件加入到分片文件列表中</span></span></span><br><span class="line"><span class="language-javascript">                fileReader.<span class="title function_">readAsArrayBuffer</span>(filePart); <span class="comment">//将分片文件使用FileReader读取</span></span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">loadNext</span>();</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>前端代码中主要看 <code>sliceFileAndUpload</code>方法的实现，注意分隔的起始和结束位置的确定，具体讲解可看视频中的讲解。</p>
<h4 id="代码仓库地址"><a href="#代码仓库地址" class="headerlink" title="代码仓库地址"></a>代码仓库地址</h4><ul>
<li><p>Gitee：<a class="link"   href="https://gitee.com/hlovez/upload-slice.git" >upload-slice: 分片上传文件Demo项目<i class="fas fa-external-link-alt"></i></a></p>
</li>
<li><p>GitHub: <a class="link"   href="https://github.com/xiaohu-pro/upload-slice.git" >https://github.com/xiaohu-pro/upload-slice.git<i class="fas fa-external-link-alt"></i></a></p>
</li>
</ul>
]]></content>
      <categories>
        <category>技术分享</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
        <tag>JavaScript</tag>
      </tags>
  </entry>
</search>
